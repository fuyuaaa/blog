---
title: çº¿ä¸Šè¯·æ±‚å¾ˆæ…¢é—®é¢˜æ’æŸ¥
date: 2020-09-05 14:22:25
tags: [å…¶ä»–]
categories: å…¶ä»–

---

## é—®é¢˜å‡ºç°

æ”¶åˆ°æµ‹è¯•çš„æ¶ˆæ¯ï¼Œé¡¹ç›®é¡µé¢æ‰“å¼€å¾ˆæ…¢ã€‚

<img src="https://fuyuaaa-bucket.oss-cn-hangzhou.aliyuncs.com/blog_pics/çº¿ä¸Šé—®é¢˜1-1.png" alt="ä¸æƒ³æ”¶åˆ°çš„æ¶ˆæ¯" style="zoom: 50%;" />



## é—®é¢˜æ’æŸ¥

1. æŸ¥çœ‹çº¿ä¸ŠJVMç›‘æ§å¹³å°ï¼Œå‘ç°æ¯åˆ†é’Ÿç”±äºGCæš‚åœçš„æ—¶é—´ 30~50sã€‚

   ![æ¯åˆ†é’ŸGCæš‚åœæ—¶é—´](https://fuyuaaa-bucket.oss-cn-hangzhou.aliyuncs.com/blog_pics/çº¿ä¸Šé—®é¢˜1.2.png)

2. è¿›å…¥çº¿ä¸Šæœºå™¨ï¼Œ`jstat -gccause pid time`ï¼Œå‘ç°è€å¹´ä»£çš„å æ¯”ä¸€ç›´åœ¨99%å·¦å³ï¼Œå¹¶ä¸”å‘ç”Ÿfull gcä¹‹åï¼Œå˜åŒ–å¾ˆå°ã€‚

   ç„¶åï¼ŒæŸ¥çœ‹çº¿ä¸Šgcæ—¥å¿—ï¼Œå‘ç°è€å¹´ä»£çš„ç©ºé—´åœ¨full gc å‰ååŸºæœ¬æ— å˜åŒ–ã€‚ï¼ˆå¤§æ¦‚ç¡®å®šæ˜¯å†…å­˜æ³„æ¼äº†ï¼‰

![gcæ—¥å¿—](https://fuyuaaa-bucket.oss-cn-hangzhou.aliyuncs.com/blog_pics/çº¿ä¸Šé—®é¢˜1-3.png)

3. äºæ˜¯ä¹ï¼Œjmapæ•´ä¸ªdumpæ–‡ä»¶ã€‚åœ¨dumpæ–‡ä»¶ç”Ÿæˆä¹‹åï¼Œå…ˆæŠŠçº¿ä¸Šæœºå™¨é‡å¯äº†ï¼ˆå› ä¸ºæ˜¯è€é¡¹ç›®ï¼Œæœ€è¿‘æ²¡æœ‰é‡å¯ï¼Œæ‰€ä»¥åŸºæœ¬ä¸Šå¯ä»¥åˆ¤æ–­ä¸æ˜¯ç”±äºä¸šåŠ¡ä»£ç çš„é€»è¾‘é—®é¢˜ï¼Œæ‰€ä»¥å…ˆé‡å¯ä¿è¯çº¿ä¸Šå¯ç”¨ã€‚é‡å¯åè§‚å¯Ÿå†…å­˜æƒ…å†µï¼Œå‘ç°æ˜¯æ­£å¸¸çš„ã€‚ï¼‰
4. æ¼«é•¿åœ°ç­‰å¾…dumpæ–‡ä»¶çš„ä¸‹è½½ï¼ˆä¹Ÿå°±3.47Gï¼Œå…¬å¸çš„ç½‘ä¹Ÿå°±ä¸‹äº†å¿«2å°æ—¶ï¼Œæ’æŸ¥é—®é¢˜çš„ä¸»è¦éšœç¢æ˜¯å…¬å¸çš„ç½‘ç»œã€‚ï¼‰

<img src="https://fuyuaaa-bucket.oss-cn-hangzhou.aliyuncs.com/blog_pics/çº¿ä¸Šé—®é¢˜1-4.png" alt="dumpæ–‡ä»¶" style="zoom:25%;" />

## åˆ†æåŸå› 

1. Jprofileræ‰“å¼€dumpæ–‡ä»¶ã€‚è¿™ä¸ªchar[]çš„å¤§å° å’Œ ConcurrentHashMap$Nodeçš„æ•°é‡ï¼Œæä¸ºå¯ç–‘ã€‚

![åˆ†ædumpæ–‡ä»¶](https://fuyuaaa-bucket.oss-cn-hangzhou.aliyuncs.com/blog_pics/çº¿ä¸Šé—®é¢˜1-5.png)

2. åˆ‡æ¢åˆ°Biggest Objectsã€‚å‘ç°FallbackModuleMappingRuleè¿™ä¸ªå¯¹è±¡é‡Œå­˜åœ¨ä¸€ä¸ªåä¸ºcacheçš„ConcurrentHashMapå¯¹è±¡å äº†2475MBçš„å¤§å°ï¼ˆçº¿ä¸Šè€å¹´ä»£æ‰2.5Gï¼‰ã€‚

![åˆ†ædumpæ–‡ä»¶](https://fuyuaaa-bucket.oss-cn-hangzhou.aliyuncs.com/blog_pics/çº¿ä¸Šé—®é¢˜1.6.jpg)

3. æŸ¥çœ‹mapçš„å…·ä½“èŠ‚ç‚¹ä¿¡æ¯ï¼Œå‘ç°å­˜çš„æ˜¯urlçš„pathä»¥åŠå…¶å¯¹åº”çš„moduleï¼ˆwebx3é¡¹ç›®ï¼‰ã€‚

![åˆ†ædumpæ–‡ä»¶](https://fuyuaaa-bucket.oss-cn-hangzhou.aliyuncs.com/blog_pics/çº¿ä¸Šé—®é¢˜1-7.png)

4. çœ‹äº†ä¸€ä¸‹FallbackModuleMappingRuleè¿™ä¸ªç±»ï¼Œå‘ç°æ˜¯ç”¨æ¥æ˜ å°„ module ä¸ screen é‡Œçš„ç±» çš„å…³ç³»çš„ã€‚å‡ºç°urlçš„pathçš„åŸå› æ˜¯å› ä¸ºï¼Œurlè¢«ç¼–ç å?è¢«æ•´æˆäº†%3Fï¼Œç„¶åè¢«è®¤ä¸ºæ•´ä¸ªè·¯å¾„éƒ½æ˜¯pathï¼Œæ‰€ä»¥æ‰¾ä¸åˆ°moduleï¼Œå°±ç”¨äº†æ•´ä¸ªè·¯å¾„ã€‚

   ![FallbackModuleMappingRule](https://fuyuaaa-bucket.oss-cn-hangzhou.aliyuncs.com/blog_pics/image-20200908151216651.png)

5. ç…§ç†è¯´ä¸è¯¥æœ‰è¿™ç§è¢«ç¼–ç å¥½å‡ æ¬¡çš„urlã€‚æ‰€ä»¥å»é“¾è·¯ä¸Šç…äº†ç…ç±»ä¼¼è¯·æ±‚çš„user-agentï¼Œå‘ç°æ˜¯æœç´¢å¼•æ“èœ˜è››ã€‚ï¼ˆé ï¼Œèƒ½ä¸èƒ½ä¸“ä¸šç‚¹ï¼Œè¦çˆ¬å°±å¥½å¥½çˆ¬ï¼‰

   %253F è§£ç ä¸€æ¬¡æ˜¯ %3F ï¼Œå†è§£ç ä¸€æ¬¡æ˜¯ ? ã€‚
   
   ![user-agent](https://fuyuaaa-bucket.oss-cn-hangzhou.aliyuncs.com/blog_pics/image-20200910103830964.png)

![user-agent](https://fuyuaaa-bucket.oss-cn-hangzhou.aliyuncs.com/blog_pics/image-20200910103920499.png)

## è§£å†³æ–¹å¼

1. filterå¯¹urlåšå¤„ç†ã€‚
2. åå°„è·å–FallbackModuleMappingRuleçš„cacheï¼Œå®šæ—¶æ¸…ç©ºã€‚
3. ...

## ps

ç»´æŠ¤è€é¡¹ç›®å¤ªnméš¾äº†ã€‚

æ¨èğŸµã€Š[é—®é¢˜å‡ºç°æˆ‘å†å‘Šè¯‰å¤§å®¶](http://music.163.com/song?id=28587850&userid=100517497)ã€‹